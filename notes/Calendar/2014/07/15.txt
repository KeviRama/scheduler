Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2014-07-15T09:40:26+01:00

====== Tuesday 15 Jul 2014 ======

Started trying to make sure that both teaching groups and tutor groups stay with their respective eras.  Try a fresh run.

Amended the loader to look for records by era where appropriate.  Also calculate start year based on the current era, rather than hard coding it.

Making progress.  Now - why do new pupils need a second pass in order to load them into their teaching groups?

Ah yes - I'm assembling my lists of group membership //before// I load pupils into the database, and one of my test criteria for being a member of a group is that the pupil should have a record in the database.  Since he doesn't at the time, he doesn't get into the group.

Why is this a criterion?  Am I not merely manipulating memory records at this point?  What would happen if I were to remove that test?  I can't see a reason for it to be there.  Try taking it out.  Seems OK.  There is still an issue with tutor groups not being created for brand new members of staff without a second pass, but that's more complicated.  The tutor group needs to contain the staff member's unique d/b id, and that doesn't exist until the staff member is created.  I think I'll just put up with that for now.

Now - what about my missing tutor registration periods.  I seem to have a "JAC 4a Assem" and "JAC 4a Chap" in my teaching group list, but no "JAC 4a Tu", which is what I'd need for my periods.  Why not?  It appears to be in the groups.csv file.  Lines as follows:

246,,25805,"JAC 4a Assem",22,4181,1,106,,,378,"JAC 4a Assem",0,,,,,,0,,0,1,,,,1,0,,,0,,,,,0,0,0,,
246,,25806,"JAC 4a Chap",22,4107,1,106,,,379,"JAC 4a Chap",0,,,,,,0,,0,1,,,,1,0,,,0,,,,,0,0,0,,
246,,25807,"JAC 4a Tu",22,4116,1,106,,,273,"JAC 4a Tu",0,,,,,,0,,0,1,,,,1,0,,,0,,,,,0,0,0,,
358,,32227,"JAC 4a Chap",22,5443,1,106,,,379,"JAC 4a Chap",0,,,,,,0,,0,1,,,,1,0,,,0,,,,,0,0,0,,
358,,32276,"JAC 4a Tu",22,5452,1,106,,,273,"JAC 4a Tu",0,,,,,,0,,0,1,,,,1,0,,,0,,,,,0,0,0,,
358,,32783,"JAC 4a Assem",22,5512,1,106,,,378,"JAC 4a Assem",0,,,,,,0,,0,1,,,,1,0,,,0,,,,,0,0,0,,

Now, 3 of those should be from last year and 3 from this year.  The sixth field is CurrIdent.  Indirecting through these I find that the first three relate to academic year 14 in SB (2013/14) and the last three relate to academic year 15 (2014/15).  So far, all seems correct.  Does "JAC 4a Tu" have any members?  The third field is the group ident and should be referenced from AcademicRecord.csv  No, it doesn't have any members, which explains the problem.  Perhaps I should allow sets into my database, even if they currently have no members?  How many does that add?  None - there must be another test.  Yes indeed.  Now run it and it adds an extra 19 teaching groups.

And finally, although I have 968 pupils, the new ones don't seem to have tutor groups yet.  Find the name of a pupil with no tutor group, and check him in SB.

Also, my lower sixth further maths set doesn't seem to have made it into the system either.  Presumably also lacks pupils, and Peter has done really silly things with the set names.  Let's see what it's actually called now.  It seems to be called "S6 R FM-2P".

358,,32630,"S6 R FM-2P",18,5489,1,,,,124,"S6 RMaP FM-2P",0,,,,,,0,,0,1,,,,1,0,,,0,,,"2P",,0,0,0,,

Check that this is for the current year by checking 5489 in the Curriculum list.  Yes, it is.  So does it have any members?  32630 in the academicrecord file.  No entries.  Clearly they haven't fixed up the set membership yet, and because it has a silly name it hasn't been loaded.  Let's add that silly name to my acceptable list.  And off we go again.  Added a further 34 teaching groups, and now I seem to have a full calendar.  Check it again against my printed one.  Eeees perfect (except for SB having tutor periods wrong).  Excellent.

Now for a tutor-less pupil.  Presumably late in the file.  At a random choice, try "Charlie White".  No - he doesn't seem to be one of ours.  Be more systematic - look for a pupil with no tutor group in my d/b.  A quick bit of code throws up 262 such pupils.  Interesting.  Restrict myself to current pupils.  Now I have 85.  Is that the right number?  Yes - precisely the right number.  Let's examine some of them.  The first one is Angus Blomfield.  Let's look at him directly in SB.  Interesting.  SB says he is a third year and his tutor is Helen Wenham, who must be new.  Do we have records for Helen Wenham?  Yes, we do.  And I've loaded this data set umpteen times so it should have had time to create the tutor group by now.  Ah!  She doesn't have an e-mail address, and so she's been marked as neither active nor current.  This is probably the problem.  Edit her manually and see if things improve.

Hmmm.  The loading process promptly removes her e-mail address again, but it shouldn't have changed the flags.  It also didn't create an additional tutor group.  Why not?  The flags are still set to true.  What is her user ident?  877.  Does she have any entries in the tutor group file?  Yes, she has 19.  Angus Blomfield is pupil number 2, and yes, he's in her tutor group.  Why haven't I assembled it then.  Have I messed up the code for creating new tutor groups entirely?

No - I'm consulting the wrong active flag.  I'm looking at my in memory flag to decide whether the staff member is active, and that's set to false because she has no e-mail address.  I should instead by checking the d/b flag, because I might want to override the calculated one - as indeed I do in this case.

That's done it - now I have one more tutor group.  Who else lacks a tutor group, and who is the tutor?  Alternatively, who are my recently added members of staff?

[*] Helen Wenham (HJW)
[*] James Golding (JMG)
[*] George Draganov (GTD)
[*] Matthew Poynter (MJP)
[*] Elliot Paige BirkBeck (EPB)
[*] Regina Engel-Hart (REH)
[*] Maud Cottrell (MFFC)

Steps needed to do the live system.

[*] Back up the d/b
[*] Distribute the new source code
[*] Set my seven staff members to active and current
[*] Load a fresh set of calendar data
[*] Run the script to set TeachingGroups and Pupils to current.
[ ] Load the data files from SB


Ha!  Lesley seems to have added the week letters to the calendar.  See if those work OK.  One Detention Duty Master slot has no name, but that's hardly my problem.  We seem to have our week letters - hurrah!

The big load is now running on Mach2.  I wonder how long it will take.

I'm inclined to try to get other half things in next.  Currently all the groups are empty, so they're not being imported.  ISTR I had worked out where in the database the events were being scheduled.

Eventually it finished - it took 107m 29.618 s.  How long will a re-run using the same data take?
1m 53s.  No issues raised.  Now let's try running a complete SB query and load.  That has actually produced quite a lot of set changes.  Boys moving between sets in various years.  8 new teaching groups.  379 moved into groups and 73 moved out.  Took 2m 41s in total, including the time taken to dump from SB.  Excellent.

Back to working on my development machine.  Can I find where the Other Half activities are scheduled?

rtrwgroups.csv rings a bit of a bell.  It certainly seems to contain entries for other half activities.  Can I use these to establish when other half things are happening.

I don't think SAE has put the schedule for next term into SB yet, but I can look for last term's.  SB shows me taking Computer Programming in M111 from 13:15 to 14:55 each Monday.  Can I find that in the file, and link it to that day and time?

There seem to be lots of lines for Computer Programming.  Perhaps there is one per occurence?  Ah, there are also entries for "Computer Programming (M5/6)", which is about the right time, and whilst the M5/6 bit doesn't appear in the SB display, there is clearly something on the next line which their pathetic schedule display code is failing to display.

RTRWGroupsIdent,RTRotaWeekIdent,GroupIdent,GroupDay,GroupStart,GroupEnd,SCTIdent,RoomIdent,GroupRota,GroupSlotTime,StaffIdent,StaffIdent2,GroupName,DateIdent,RTGroupChecked,RTProtectedGroupClash,UserIdent3,UserIdent4
14047,218,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4060,0,0,,
14157,220,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4067,0,0,,
14557,225,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4074,0,0,,
14841,229,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4081,0,0,,
14932,232,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4088,0,0,,
15220,236,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4095,0,0,,
15621,241,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4109,0,0,,
15854,245,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4116,0,0,,
15992,248,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4123,0,0,,
16233,252,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4130,0,0,,
16394,255,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4137,0,0,,
17968,278,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4165,0,0,358,
18092,281,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4172,0,0,358,
18174,284,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4179,0,0,358,
18537,289,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4186,0,0,358,
18621,292,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4193,0,0,358,
18876,296,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4207,0,0,358,
19119,300,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4214,0,0,358,
19297,304,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4221,0,0,358,
19548,308,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4228,0,0,358,
19818,312,10792,1,795,895,13,287,0,100,743,358,"Computer Programming (M5/6)",4235,0,0,358,

Can we link this to anything?  The third field is meant to be a group ident, and it's always 10792.  What is group 10792?  It's the group of the same name.  Good start.  Now, note we have StaffIdent, StaffIdent2, UserIdent3, UserIdent4.  (The Staff table was clearly called User at one point, and has been partially renamed.)  Anyone we can identify?

358 is me, so it looks like I was added at the tail end to just some of them.
743 is VDP
358 is me again - I'm in two different fields.

GroupDay contains 1 every time.  Monday?
GroupStart is 795
GroupEnd is 895

795 / 60 = 13.25.  or 13 hours 15 minutes
895 / 60 = 14.9166666 or 14 hours 55 minutes

Clearly the duration.

RoomIdent is 287 - M111.

It'll have to be RTRotaWeekIdent which tells us the week surely?  First few values are:

218, 220, 225

These give me corresponding DateIdents of:

4060, 4067, 4074

which in turn are:

6/1/2014, 13/1/2014, 20/1/2014

Those are in fact Mondays, but given the naming convention they might be intended merely to convey the start of the relevant week.  Need to check another activity which isn't on a Monday.  Martin has had Robotics Club on a Friday.  Do the same test for a couple of those entries.

14051,218,10786,5,810,885,13,268,0,75,473,473,"Robotics Club (F5/6)",4060,0,0,,
14139,220,10786,5,810,885,13,268,0,75,473,473,"Robotics Club (F5/6)",4067,0,0,,
14556,225,10786,5,810,885,13,268,0,75,473,473,"Robotics Club (F5/6)",4074,0,0,,

We have 218, 220, 225 - exactly as for Computer Programming on the Monday.  Yes, we clearly are going by the start of the week - the Monday.  Then the GroupDay field tells you what day in that week.  Half-arsed or what?

I've just discovered something odd.  Although the rtrwgroups record references a group, (which should tell us which pupils are involved in an activity) we also have the rtrwpupils file, which has a lot of entries and seems to be trying to link pupils to activities too.  I wonder whether these could be registration records?

Taking the first RTRWGroupIdent from Computer Programming - 14047 - I get the following records from the rtrwpupils file.

210988,66,14047,,795,895,1,0,0,0,0,
210989,117,14047,,795,895,1,0,0,0,0,
210990,158,14047,,795,895,1,0,0,0,0,
210991,212,14047,,795,895,1,0,0,0,0,
210992,260,14047,,795,895,1,0,0,0,0,
210993,261,14047,,795,895,1,0,0,0,0,
210994,605,14047,,795,895,1,0,0,0,0,
210995,2632,14047,,795,895,1,0,0,0,0,
210996,3297,14047,,795,895,1,0,0,0,0,
210997,3617,14047,,795,895,1,0,0,0,0,
210998,4398,14047,,795,895,1,0,0,0,0,
210999,4727,14047,,795,895,1,0,0,0,0,

with the second field being the PupOrigNum or pupil identifier.  These pupils are:

Alexander Mannix
Silas Gill
Joseph Curtis
James Kennedy
Lewis Wu
Piers Clark
etc.

However, I have no idea who would have attended that activity.  Let's try mine back in January.

For "Computer Project (F8)" I get:

14041,218,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4060,0,0,,
14161,220,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4067,0,0,,
14549,225,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4074,0,0,,
14866,229,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4081,0,0,,
14948,232,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4088,0,0,,
15222,236,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4095,0,0,,
15634,241,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4109,0,0,,
15846,245,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4116,0,0,,
16006,248,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4123,0,0,,
16228,252,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4130,0,0,,
16386,255,10898,5,960,1020,13,288,0,60,358,,"Computer Project (F8)",4137,0,0,,

Notice the week idents start at 218 again, and the day is 5 (Friday).  Looking now for 14041 in the pupils file I get:

210946,88,14041,1,960,1020,5,0,0,0,0,358
210947,212,14041,,960,1020,5,0,0,0,0,
210948,260,14041,1,960,1020,5,0,0,0,0,358
210949,445,14041,,960,1020,5,0,0,0,0,
210950,605,14041,1,960,1020,5,0,0,0,0,358
210951,738,14041,1,960,1020,5,0,0,0,0,358
210952,740,14041,1,960,1020,5,0,0,0,0,358
210953,2864,14041,1,960,1020,5,0,0,0,0,358
210954,3130,14041,1,960,1020,5,0,0,0,0,358
210955,3583,14041,1,960,1020,5,0,0,0,0,358
210956,3863,14041,1,960,1020,5,0,0,0,0,358
210957,4333,14041,,960,1020,5,0,0,0,0,
210958,12461,14041,1,960,1020,5,0,0,0,0,358

and this yields the following pupils:

Oliver Moody
James Kennedy
Lewis Wu
Jack Bowen
Alex Taylor
Julian Ting
Yegor Pomazounov
Jake Drew
Marcus Green
Ivan Leung
Dmitry Muravyev
Jai Sidpra
Aidan Grenville

all of whom might have been there, but I'd be surprised to get the lot at the same time.  Could these be registration records for all those who //could// be there, and perhaps that fourth field contains a 1 if they were?  It's called RTPupAttend, so perhaps it is.  What does the corresponding group indicate as the membership?  Group 10898 is Computer Project.  Can I find its membership?  Perhaps through my application.  Found it - it used to have 11 members.  Much the same people too.

OK - I think I know how this goes now.  Presumably I just need to create a calendar entry for each of these entries.  I could do with a new category (to ease purging) and I can identify them by source_id.

Proposed strategy.

First read in all the rtrotaweek records and index them, sorting out their dates.  Each can be an object which is capable of providing an actual date when given a day number.

Then read in the rtrwgroups records, link to the corresponding staff, teachinggroup, and room, and record the correct date for it.  Then process them in date order, starting at whenever we currently start.
