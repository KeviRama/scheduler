Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2014-06-06T08:21:08+01:00

====== Friday 06 Jun 2014 ======

Plan of campaign

* Get full structured loading working - tidied up
* Implement login
* Implement simple event filtering

There will still be a lot to do after that (manual event creation and editing, plus searches like - all the people who teach this group of boys in this time interval) but I then should have something demonstrable which people can understand.

I think I'll start by implementing LocationAliases.

An interesting question arises about the use of the "active" flag.  Currently I have an "active" flag in both Location and Staff records.  The purpose of the flag in Staff records is to allow staff to be recorded in the system, but not appear in any current searches.  Thus we can have staff who have left (but who should still appear in historic records) and staff who have never really existed (e.g. Abeda Choudhry) but who are in SB and thus we need a record not to load them again.

For Locations, I'm now going to handle the blocking via LocationAliases.  Rubbish records in SB will result in a LocationAlias but no corresponding Location.  I might however want to have a historic record of real locations.  It could be that a classroom will cease to exist (e.g. SAnn) over the life of the system.  They should then cease to be offered in searches (like a staff member who has left) but should not be expunged from the system, so historic records still show them in use.  Yes, I definitely still want the active flag in Location records.

Hit an interesting problem when running automated tests.  Both teaching groups and tutor groups need a starts_on date to be passed through to the underlying Group model.  Currently there is no way to enter this in the creation dialogue, and I don't actually anticipate wanting to create them manually anyway.

For now I have added code to the controller to add this field if it hasn't been specified by the dialogue.  It can't be specified through the dialogue.

I also need to work out how to pass back the error message when creation of a teaching/tutor group fails because the underlying group fails.

Back to trying to load my SB data in a neater fashion.  Start by deleting everything which is there and came from SB.

* Events
* Staff
* Pupils
* Teachingroups
* Tutorgroups
* Locations

Pupils then seem to load OK.  Fails on locations, which is hardly surprising.  Can I have my loading code concern itself entirely with location aliases and then have the locations created automatically?  Should be possible.  Done it.

I have a slight oddity, in that events involving "6 Spt" don't seem to be attached to that teaching group.  Checking the input files from SB, its ID is 25614 and it has no members, but given its name I should still be creating it.  Am I creating it?  Yes - I have created it.  Why then does the event not get linked to it?  Possibly because I checked earlier for it and didn't find it and have failed to update my cached idea of whether it has a db record.  Update teaching groups to use my DatabaseAccess model.

I've just noticed something really weird - all my lessons in week A have the wrong timing - they're 35 minutes instead of 50/55 minutes.  Have I perhaps misinterpreted the significance of the fields in the PeriodTime records?

I have filtered the displayed events down to just mine, and they're all there, but just at completely the wrong time.  Time to do a bit of drilling down to find out why.

Pick an event at random in week A. - My appointment with my tutor group in chapel.  It should be from 08:40 to 08:55 (or SB in week B has it as 08:30 to 09:00, which is wrong, but better than I'm getting in week A.  Currently in week A it shows as being at 13:25 to 13:30.

Source event number 283208.  Line from timetable.csv reads:

'''
283208,25800,358,303,2,14
'''


283208 is the event number
25800 is the group number
358 is the staff number
303 is the room number
2 is the period
14 is the academic year

My corresponding chapel period in week B has a period number of 14.  Looking in period.csv for those two we find:

'''
Period,DayName,TeachingPeriod,PeriodWeek
1,"Monday",0,1
2,"Monday",1,1
'''

'''
14,"Monday",1,2
'''


So they both have a TeachingPeriod of 1, and then the week number is 1 for week A and 2 for week B, as I had expected.  TeachingPeriod seems to be a flag rather than an index - it's always 0 or 1.  Looking at periodtimes.csv we have:

'''
PeriodTimesIdent,PeriodTimeStart,PeriodTimeEnd,Period
2,510,540,2
69,510,540,14
135,805,810,2
'''


which seems to place them both as running from 08:30 for 30 minutes.  Where then am I getting the other time from?  13:25 to 13:30 would have minute values of 805 to 810.  Is there such a period time?  Yes, there is, and it too points to period 2.  How does one decide which of the two to use?  As a first guess, I could just take the first effort at each one which I find.  Try it.  That does seem to have been tolerably successful.  And it gave an opportunity to test my code which adjusts existing events.

Ah - there is a column in the period times which isn't in my current export.  It's called PeriodTimeSetIdent and it contains 2 for the time which I want, and 3 for the one which I don't.  Add that to my export and start filtering.
