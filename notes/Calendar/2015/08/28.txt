Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2015-08-28T07:48:45+01:00

====== Friday 28 Aug 2015 ======

Slightly puzzled this morning because apparently 21 pupils have changed tutor groups, (suggesting a change of tutor) and yet no-one has been added to or removed from my list of tutors.  Just had a thought - perhaps a couple of tutors have swapped their tutees - some moving one way and some the other.  Loading into Markbook will probably tell me more.  A markbook load is overdue anyway.

Yes, they had indeed swapped.  Slight problem with the loader code in Scheduler.  When it adds a pupil to a tutor group it gives the pupil record a chance to update its element name, but when it removes a student it doesn't.  As a result, all the students who went one way now have the correct tutor group name, and all the ones who went the other don't.  Things to do today then:

[*] Fix the loader code so that element name always gets updated
[*] Add a helper method to fix the students currently broken
[*] Fix default values on eventcategories
[*] Change helper method not to over-ride defaults unnecessarily (although it should never be used again).
[*] Polish interval time formatting further - encapsulate it
[ ] Promote to live system
[ ] Run the helper method to fix element names
[ ] Tell DJD and Karen that SUS is sorted

Before I fix the loader code, let's just take note of two students who demonstrate the problem.

Jake Pennington moved from SJP to NJK but appears as 6SJP
Jack Tibble moved from NJK to SJP and does appear as 6SJP

fix code and reload on test system.

Should also test that their erstwhile membership records have gone entirely.  The correction of names seems to have worked.  Jake Pennington is element 9579 and Jack Tibble is 9471.  Check their membership history.

Jake Pennington has 59 membership records in total.  Only three of these relate to tutor groups - one 4th year, one 5th year and one 6th year.  There is none for 6SJP, not even an expired one.  Good.

Interestingly, his old tutor group ends on the 30th August.  Shouldn't that be the 31st?  Have I subtracted a day when I shouldn't have done?  The era ended on the 31st.  Check the end_of_year rollover code.  Yes indeed - I have passed in the date of the end of the era to group.ceases_existence().  The thing is, that method expects the first day of non-membership to be passed in.  This makes perfect sense when passing in Date.today.  If I say someone stops being a member of a group today, then ask if he's still a member I don't expect the answer yes - I want him to stop being a member immediately.  For the end of an era therefore, I want to pass in the day after the era ends.  The error won't hurt for now, but I'll fix it now so it's correct next year.  Fixed.

Now I need a helper method to correct the existing student element names on the live system.  Not quite sure where to put that.   There seems to be far less clever code gluing together groups and their personae than I thought.

Ah no - there's something linking them together.  If I find a tutorgroup by name then the object which I have is of class Group, but I can call house() on it, which is defined only in the persona.  How did I do that?  Ah, I seem to have done it through method_missing.  I should be able to put the method in the tutorgroup persona then, and call it on the group.

Now to test it, I actually need a copy of the current live database, since my test database no longer has the problem in it.  Seems to think it has done something.  Take a look.  Yes, Jake Pennington now appears as "Jake Pennington (6NJK)".  Good.  The command to correct things once the new code on the live system is:

'''
tg = Tutorgroup.find_by(name: "6NJK")
tg.fix_pupil_names
'''


On the Eventcategory defaults, it seems that it's only the pecking order which needs a default.  The compactable one is already set to true, and all the others seem sensible.  It seems there is a change_column_default instruction which sounds like the best way to do it.  Done that I think.

Now - how do I really want times to be displayed?  24 hours times are easy.

12:00 - 14:00		For an interval
13:35				For a single time

They always get all the digits and there's no need of any spaces.  12 hour times are more complex.  The simplistic approach is to go for:

''11:30 am-12:15 pm''

Various questions immediately arise.  Do I want a space before am or pm?  Do I always want the minutes digits?  Can I suppress one of the am/pm bits if they're both the same?  Do I need a space around the hyphen?

10:00-11:30 am
10:00 am-12 noon
10:00am-12 noon

10:00 - 11:30 am
10:00 am - 12 noon
10:00am - 12 noon

I think I do prefer a space before the am/pm - it also makes it consistent with the noon bit.  What about a single time?  Or both times with no minutes?

11 am
9-11 am
9 - 11 am

Those both look fine.  What about?

9-11:30 am
9 - 11:30 am

Less fine somehow.

9:00 - 11:00 am
9:00 - 11:30 am
9:00 am - 2:30 pm

That sort of complexity does really cry out for the space.

12:00 noon looks a bit odd.
12 noon is better.

Noon never gets any minutes.  Try this - if neither time has any minutes, don't give any minutes, but if at least one does then do give minutes.

12 noon to 2:30 pm
11 am to 2 pm
11:00 am to 2:30 pm
9:30 to 11:00 am

