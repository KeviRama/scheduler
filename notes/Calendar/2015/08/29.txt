Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2015-08-29T12:39:21+01:00

====== Saturday 29 Aug 2015 ======

Whilst preparing to load data into Markbook, I discovered there were still some issues over element names getting updated.  Narrative copied from Markbook notes:

Looking at loading the latest SB data into Markbook.  There seems to have been some musical chairs going on with tutor groups, plus a few more students have left.

This looks to me like a good opportunity to take a sample of the shuffling students and check that they've ended up in the right tutor group and with the right element/resource name on both Scheduler and Markbook.  The new data have been loaded automatically into the live Scheduler system and into my test Markbook system.  For each student it might also be interesting to note where he is on the live Markbook system, which has not been updated.  Who to check?

Joseph Truran	SJP => NJK
Thomas Bishop	NJK = SJP
Andy Zhang		AGMS => EPB		An oddity on his own?
Johnny Lloyd		AJM => HMAB
Matthew Kunov	AYC => AJM
Charlie Stoker	HMAB => AYC


There also seems to have been some tutor shuffling:

HMAB from RSS to MAK	\
AJM from MAK to ENFS	 > A complete circuit
AYC from ENFS to RSS		/

HMAB was and is 5th year
AJM changes from 5th to 4th
AYC changes from 4th to 5th

Note that the student moves exactly counter the tutor moves, so each student has stayed with the same house but changed his tutor.

=== Joseph Truran ===

Scheduler:		Joseph Truran (6NJK) in MAK
Test markbook:	Joseph Truran (NJK) in 6NJK (MAK)
Live markbook:	Joseph Truran (SJP) in 6SJP (MAK)

=== Thomas Bishop ===

Scheduler:		Thomas Bishop (6SJP) in MAK
Test markbook:	Thomas Bishop (SJP) in 6SJP (MAK)
Live markbook:	Thomas Bishop (NJK) in 6NJK (MAK)

=== Andy Zhang ===

Scheduler:		Andy Zhang (4AGMS) in 4EPB (JMG)		Not right!
Test markbook:	Andy Zhang (EPB) in 4EPB (JMG)
Live markbook:	Andy Zhang (AGMS) in 4AGMS (JAC)

=== Johnny Lloyd ===

Scheduler:		Johnny Lloyd (5AJM) in 5HMAB (MAK)	Not right!
Test markbook:	Johnny Lloyd (HMAB) in 5HMAB (MAK)
Live markbook:	Johhny Lloyd (AJM) in 5AJM (MAK)

=== Matthew Kunov ===

Scheduler:		Matthew Kunov (4AYC) in 4AJM (ENFS)	Not right!
Test markbook:	Matthew Kunov (AJM) in 4AJM (ENFS)
Live markbook:	Matthew Kunov (AYC) in 4AJC (ENFS)

=== Charlie Stoker ===

Scheduler:		Charlie Stoker (5HMAB) in 5AYC (RSS)	Not right!
Test markbook:	Charlie Stoker (AYC) in 5AYC (RSS)
Live markbook:	Charlie Stoker (HMAB) in 5HMAB (RSS)


Clearly something is still not right in my loader code when it comes to making sure element names are updated.  I thought I'd tested yesterday's change and it work in the circumstance of yesterday.  I can test it again now, before I download last night's data.  It will effect only the SJP â‡” NJK switch, but do it anyway.

Ah - I don't directly have last night's data - I did an intermediate load of data from half way through yesterday and so it already has the error in.  I need genuinely last night's backup.  I might be able to get it from Guardian.

I note also that the changes done by yesterday had changed their tutor groups, but not who they had registration sessions with.  Have those changed today?  Look at the live system.  Yes, that does seem to have been updated.  Joseph Truran is still in MAK 6C Tu, but the sessions are now with MJK instead of SJP.

Guardian does seem to have succeeded in taking a backup in the small hours of this morning, so the database dump I want should be the "previous" one in that image - from 02:30 yesterday morning.  No - this mornings backup contains a dump from 02:30 today, plus one from 10:55 yesterday.  Back a day.  Yes, it's there.  Copied it over.  Joseph Truran is now entirely with SJP and Thomas Bishop is entirely with NJK.  Run an import with yesterday's data files, but with my "fixed" code from yesterday.  It just reports that 21 students have changed their tutor groups.  Check my sample two.  Joseph Truran (6MJK).  Thomas Bishop (6SJP).  Yes, I did test it yesterday and it did work.

Let's now re-load that raw database, but then load today's data files.  (Keep a copy of yesterday's first).  Check Charlie Stoker before the load, and all of Charlie, Joseph and Thomas afterwards.

Before:
Charlie Stoker (5HMAB) in RSS 5a Tu
Joseph Truran (6SJP) in MAK 6c Tu
Thomas Bishop (6NJK) in MAK 6b Tu

And load today's data files.  Interesting to note that three tutor groups were actually deleted, and three new ones created.  21 pupils removed (as before) 54 pupils added.  Let's check my trio.

After:
Charlie Stoker (5HMAB) in RSS 5a Tu
Joseph Truran (6NJK) in MAK 6c Tu
Thomas Bishop (6SJP) in MAK 6b Tu

So my other two have worked, but not Charlie Stoker.  Let's check his set membership.  He's in 5AYC.  He has been in 3HMAB and 4HMAB, but he has no membership record at all for 5HMAB.  Why didn't his name get updated?

Ah - perhaps he got added to his new tutor group //before// his old tutor group got deleted.  That would mean that he kept the same name.  Then when the old group went, nothing happened to cause his name to get updated.  Further thought needed.  Yes - deletions always happen at the end.  Need some extra code there to handle ex-members.  Added that code - test again.

After:

Charlie Stoker (5AYC) in RSS 5a Tu

Yay!  Are the other two still OK?  Yes.  OK - I should now be able to fix the live system using the method which I implemented before.  To test that I need to dump the live system as it is now, and copy down to my test system.

'''
tg = Tutorgroup.find_by(name: "5AYC")
tg.fix_pupil_names
tg = Tutorgroup.find_by(name: "5HMAB")
tg.fix_pupil_names
tg = Tutorgroup.find_by(name: "4AJM")
tg.fix_pupil_names
'''
 
It occurs to me that I still haven't explained Andy Zhang.  He was an individual who just changed tutor group (and indeed, house).  Why didn't his name get updated.  Is it still wrong?  I should have tested it after doing my test load.  I can do that again.  I need the database dump from 02:30 yesterday, and today's data files.  Load the data ansd check Andy Zhang.  He's still listed as being 4AGMS and yet he has no membership record for 4AGMS - just 4APB.  Why didn't his name get updated?  Check the data before running the update script.  Yes, he was a member of 4APB before the update.  Why didn't the update change his name?  Ah!  Because he had already been moved.  He didn't move as a result of last night's update - he had already been moved before I fixed the code. All I need to do then is update his set too.

'''
tg = Tutorgroup.find_by(name: "4EPB", era_id: 3)
tg.fix_pupil_names
'''
 
Oddly, this doesn't fix it.  Ah - wrong 4EPB.  He seems to have stepped back to take a 4th year group again.  Need to specify the era id too.  And on to the live system.  Done.
