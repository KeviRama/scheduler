Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2015-08-27T09:36:20+01:00

====== Thursday 27 Aug 2015 ======

I have put the new code onto the live system and so far it seems OK.  A quick speed test indicates that my tame pupil - William Richardson - is getting his ical file slightly more quickly, but it is twice as big.  If one restricts him to a comparable file by specifying a start date of 2015-09-01 it comes down in half the time (4.5s instead of 9s).  A good start.

I want to get on to providing the means to edit Concerns - colours, flags, and a route into the Days controller with tick boxes.  Before that however I would like to make a small change to the way ical downloads work if you specify a teacher's initials.

Currently, for reverse compatibility, if you specify initials then all options are ignored and you get:

* Break through events
* The teacher's explicit events

all in one go.  This is because that's the way the original implementation worked.  I then added the means to specify any element's id number and then you can put all sorts of options after it, but it's more hassle for a teacher to do that than to specify his or her initials.

It occurred to me the other day that I can still provide reverse compatibility but also give more flexibility if I say that only the case of just initials - with no options at all - will give the default behaviour.  Anyone still using that original published interface will see it continue the same.  As soon as you specify any kind of option though, it will behave as if you gave the element id number, and you will be able to use all and any of the options.

Thus:

http://abingdon.scheduler.org.uk/jhw

Gives my stuff, plus the breakthrough events.  As soon as an option is added though, e.g.

http://abingdon.scheduler.org.uk/jhw?categories=Lesson

then it's just as if I'd entered:

http://abingdon.scheduler.org.uk/10375?categories=Lesson

Ancient uses thus still see the behaviour which they were expecting, but there's more flexibility for new users who don't want to go to the trouble of looking up their id number.

At the same time it would make sense to completely remove the old ical processing from the staffs controller, which is in any case broken.

After that I'll get on to Concern editing.

[*] Remove ical from staffs controller, plus associated route
[*] Change working of initials in elements controller
[ ] On to concern editing.


I've downloaded the latest data from the live system and put it on my test system.  ical files should therefore be comparable.  Things to test.

Full calendar							Identical apart from event IDs.
Breakthrough events					Identical apart from event IDs.
ical/jhw								Identical apart from event IDs.
ical/jhw?start_date=2015-09-01			Now they're different.  Differences exactly as expected.
ical/10375?start_date=2015-09-01		This on the live system produces the same as the previous
									    URL on the test system (except IDs).

That fourth one should be different (in a predictable way) - the rest should be exactly the same.

Interesting - the old code did actually allow some parameters with initials, but I don't think I'd ever publicized the fact.  Does anyone use any?  The only ones which had any effect were dates.  No, practically no-one ever uses any parameters at all.

Should also check that Brian's exact URL produces the same output for the calendar.  And by element id.

ical/0?categories=Calendar,Week%20letter
ical/17424

All identical, except event IDs between machines.  Excellent.  I can push this to live too.

Now, I think concern editing deserves its own branch.   ISTR I did some work on just colour editing before, so that might be worth looking at.

The one I played with before is called Spectrum.  Not sure why I chose that - there seem to be a plethora of them.  In any case, colour picking is fairly low down in the order of things I want to provide.  Firstly we need an edit dialogue for Concerns.  It wants to function much like editing an event.  The coloured rectangle in the side bar should be the link to trigger it.

DJD has just interrupted me with some issues over the calendar export which Lou has done for him.  Part of the problem is her not using quite the right options, but one is a knock-on from my calendar changes.  Historically, all the Calendar events had an event category of Calendar, which has a pecking order of 50.  Week letters have a pecking order of 5, putting them first before the calendar, but everything else seems to have a pecking order of 1.  As events get converted from Calendar to other categories they therefore start sneaking in ahead of week letters.  I need to do some global editing of pecking orders to make sure Week letters come first.  To give myself some space, I should perhaps move all the general categories to about 20.  Does anything else get affected by this field?  It's called pecking_order.

Currently my code to add extra categories gives them a pecking order of 1.  Change that to 20.

No - the days controller seems to be the only thing which actually uses the field.  Everything else is just to do with editing it.  Let's just edit each of the event categories.

Test to see the problem demonstrated first.

http://abingdon.scheduler.org.uk/days.doc?compact&duration&locations&no_end_time&twelve_hour

First problem is on Mon 5th Oct, when the Abingdon Michaelmas Fair sneaks in ahead.  That's because it's a "Date (other)".  Change that one first to test.  Yes, that seems to cure it.  Let's change all the others.  That seems to have been successful.

Wondering whether I can overload the existing "compactable" flag on event categories to provide DJD with events which retain their end times.  Currently it is used on week letters to make them last all week.  That is - it is used on multi-day all-day events to make them appear on each day.  Could the same flag be used on timed events to say that the end-time should stay in.  It sounds like pretty much the same functionality.

Noticed that "compactable" seems to be defaulting to false, with the result that several other non-compactable categories have crept it.  Change them to true.  How does one change an existing d/b default value.  You use change_column.  Perhaps I should do that for the default pecking_order and compactable-ness.
