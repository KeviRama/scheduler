Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2015-03-15T07:47:34+00:00

====== Sunday 15 Mar 2015 ======

Looking at importing events from the failed school calendar into Scheduler so that it has an up-to-date copy of the events which had been entered before the failure.  A certain amount of frigging is required.

I've loaded Calendar's database into my local MySql database and it seems to make a reasonable amount of sense.  It actually contains several calendars, and I've had to guess which ones were previously included in my exports.  If you take them all you get duplicate events.  In the end I've settled on calendars 1 (called "Public calendar) and 5 ("Sports fixtures").  This seems to get me much what I had before.

In order to import the data I had to edit out part of the MySql dump file - it was a dump of the whole database including the system tables - and then edit it slightly to change Type=MyISAM in the CREATE DATABASE clauses to say instead Engine=MyISAM.  It can then be loaded using just "mysql <restore.sql".

I had to set up a user with permission to access it, and give the same user permission to write to external files.  This is a separate permission from being able to access database tables.  I also had to load timezone information into MySql and set my reading script to use UTC/GMT explicitly.

The script to export the events is:

'''
USE schoolcalendars;
SET time_zone='GMT';
SELECT 'Subject', 'Start Date/Time', 'End Date/Time', 'All day event', 'Duration'
UNION
SELECT title,FROM_UNIXTIME(starttime),FROM_UNIXTIME(endtime),allday,duration
INTO OUTFILE '/tmp/events.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '"' ESCAPED BY '"' FROM cal_Events WHERE (calendar = 1 OR calendar = 5) AND FROM_UNIXTIME(starttime) >= '2015-03-01';
'''


There are some issues with escaping because MySql really only copes with escaping embedded " characters.  At one point in the export, it tries to escape an N (no idea why, except it's in a number field) resulting in gibberish.  There appears to be no way to specify different escape characters for different circumstances.

Once the file is exported, I edit it as follows:

Lunchtime informal concert on 26/6/2015
Change that "N to "1970-01-01 00:00:00"

Detention duty on 30/3/2015
Change Mr Davies to Mr E Davies

Detention duty on 12/6/2015
Change Mr Christodoulous to Mr Christodoulou

and then we seem to have something which I can load.  Send it to Scheduler and try to load it with my new enhanced code.

One extra thing to test.  I have an event on 28/4/2015 of a Fire Service Presentation in the Amey Theatre.  The name of the theatre ends with a full stop, so I have been failing to recognise it.  I hope I've now enhanced to code to cope.  Damn - it didn't.  Why?  Ah - I'd done only the split version.  Now done the other one as well.

OK - time to risk it on the live system.  The data are already backed up as at 04:00 today.  I will use the events.csv from the staging directory on my test system, because that is already edited.
