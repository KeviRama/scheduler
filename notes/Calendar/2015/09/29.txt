Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2015-09-29T08:06:07+01:00

====== Tuesday 29 Sep 2015 ======

I thought I knew what I was going to do today - permission controls on selected resources - but now I think I'm going to do something else.  I want to

[*] Promote my new version to live, reverting to the existing colour scheme.
[ ] Improve group editing to the point where Victoria could use it.  Need some means to make them public.

Done the first one, now on to group editing.  Currently the form is a mess, and the field to enter new elements is at the bottom.  It should be at the top.

Get a copy of the live database first.

Group editing

[*] Entry field at the top
[*] Tidied up

Rest moved to next day's notes.


Interestingly, my code to return the membership of a group on a specific day doesn't seem to be working quite properly.  I have an exclusion specified for "All pupils" and yet pupils still appear in my atomic list.  Exclusions are working for individuals, but not for groups.

All pupils contains 1161 membership records, all of which are explicitly pupils.  964 are active today.  Why then are they not getting excluded from my group listing.  The other way around seems to work.  If I create an event for the group, it doesn't appear in those students' schedule, but then I'm starting with an entity and working up through groups to the events.  That's new code and I'm fairly confident in it.  This other part is quite old code, but I thought I'd tested it thoroughly.  Investigate.

My group has 7 membership records.  Let's start again with as few as possible.

Hang on - I think it may be a priorities issue.  An individual inclusion overrides a group exclusion.  Check this.  Yes, it does appear to be working as intended.

Hah - found one problem (albeit a very perverse case).

If I create a group consisting of "Prefects except Anthony Bracey" and then another consisting of "Upper Sixth except (Prefects except Anthony Bracey)", then the membership of the latter group is quite correctly shown as including Anthony Bracey.  However, if I then create an event involving that group, it doesn't show up on AB's schedule.  Further, if I look at Anthony Bracey's membership report, he doesn't appear as being a member of that group.  Sounds like there is an error in my new code after all.  Take a look at it.

The relevant code is shared between the element and membership models.  We start in the elements model.

I confess, this code is so clever I don't really remember how it works, or if it should handle this use case.

Perhaps I can write the whole data structure to a YML file just before I finish with it.  Done that - now to analyse.

Actually, rather than doing it for Anthony Bracey, let's do it for Victoria Adams.  Far less to analyse, but I'll need to set up some groups.

Right.

* Set up a group consisting of 3 admin staff (including VA).
* Then set up a group consisting of that group, but excluding VA (so two members)
* Then set up a group of 5 admin staff (including VA).
* Finally, a group which includes the last group and excludes the second one.

The last group is listed as including VA (as it should be), but when I look at it from VA's point of view, it isn't listed as being one of her groups.  Why not?  Much smaller files to work with.

Hmmmm.  Interesting.  I think it might be something to do with the fact that it's a single case exclusion - I may be missing those.  Further thought  - it could be to do with the order in which the membership records are being evaluated.  Perhaps I need to process them working back up the tree.  Would need to keep track of the depth to start with.  (Indeed, the deepest depth for each one.)  Yes, it does appear to be to do with the order of processing, but it isn't enough to track the depth.  When one mwd references another, we need to try to process the referenced one before the one doing the referencing.  How?  Two passes?

Really need to work out the longest path, by either inclusion or exclusion, to each membership record, then process them from furthest away first.

Two passes might not be enough - you could need an arbitrary number of passes.  Could work out the depth on a first path, then process in order on the second pass?

How should it work?

VA is definitely a member of an original group of five, and an original group of three.  Call them G5 and G3.

There are then two constructed groups.

G3minus consists of G3 minus VA.
G5minus consists of G5 minus G3minus

That last one therefore should include VA, but currently doesn't.  (It does when I look at a listing of the group, but when I try to start with VA and calculate her group memberships it isn't there.)

I start with a tentative list of groups of which she might be a member:

G3
G5
G3minus
G5minus

then I subtract the exclusions.  I need to do the subtraction on G3minus first (thus excluding it from the list) then do G5minus.

G3 and G5 don't depend on anything
G3minus depends on G3
G5minus depends on G5 and G3minus

I need to process G3minus first, and looking at the latest logs it seems as if I did.  Ah, but I don't actually deal with it until after the loop is done, hence it's still there when the G5minus group is processed.

I've put a slightly messy way in.  It copes fine with a simple deletion, but it won't work correctly if it's merely a partial overlap.  OTOH, a double negative with a partial overlap is just getting silly.
