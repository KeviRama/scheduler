Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2015-01-01T09:47:01+00:00

====== Thursday 01 Jan 2015 ======

Did a little aside porting my application to the latest Ruby, Rails etc. at the beginning of the break.  There were no obvious differences (especially not in the clash between Foundation and FullCalendar) so I'll leave that to one side for now.  It's still there as a branch in git.

Now I need to think about immediate requirements for the coming term.  The first and most obvious one is to retrieve all the OH records from last term.  Someone deleted them from SB yesterday, and so they got deleted from my d/b overnight.  This isn't what I wanted.  Stuart's organisational ability is non-existent, but I can keep things much more thoroughly.

Since my d/b was saved just before the data import, I should be able to restore last nights d/b backup, then run the import again with a modified version of the import code, which ignores any OH commitments in the past.  Test that first on my development system.

Things in general to do:

[*] Stop the import process affecting OH stuff in the past
[*] Load latest calendar from calendar.abingdon.org.uk
[ ] Implement gaps
[ ] Implement suspended lessons
[ ] Duty slots for next term
[*] Latest data to Markbook

I may think of other things.

I have re-loaded last night's d/b dump on my test system and the events are indeed there.  Now let's run the import script - they should go.  Of course, when I talk about events being in the past, I mean relative to the @start_date variable set in my script.  By default this is today, but it can be adjusted by a command line parameter.

Interesting - my script checked 4399 other half events for possible deletion, but deleted only 1285.  Why?  It may be that it is only Stuart's side.  Sport events seem to be still there, whilst activity events have gone.  Right - let's take a look at the code.

Preventing deletion (as opposed to amendments) seems to be very simple indeed.  Currently I go back to the start of the era looking for events - all I need to do is go from my start_date instead.  Let's start by testing that change.  Seems to work - it now detects no other half events, and deletes none.  Excellent.  What about amendments though?  Also don't want to load any in the past.  Could just filter them at the point of entry in the wanted? method.  Is that how I do it for lessons?  No, because that's a fortnightly recurring timetable.  I do those by working through the dates.  Covers are also affected by the start_date, and there I check them as I'm shoving them into the d/b.

Is there any danger to discarding OH events as I read them if they're too early?  Without my first change (don't delete any in the past) it would cause all past OH events to get deleted all the time, but provided that's there I think I'm OK.  Try it anyway.

Ah - problem.  At present //all// the other half events are in the past and get thrown away, with the result that my loading code then decides the file is empty and processing does not proceed.  This is an important safety check, because genuinely empty files (e.g. because we failed to talk to the SB server) could cause me to throw away lots of important information.  I will therefore remove that check and do the check in the do_other_half method.

And then presumably I should promote this change to the live system.  Care needed, because I want to roll back the d/b to how it was early this morning.  Steps:

[*] Take a copy of the d/b dump file which I want to reload
[*] Stop nginx
[*] Dump the d/b again for safety
[*] Reload my earlier dump
[*] Get the latest application code
[*] export RAILS_ENV=production
[*] Re-run last night's import with the same data files.
[*] Re-start nginx

Let's give it a go.

Finished - seems OK, but I'll need to keep a close eye on it over the next few days to make sure that the new term's OH events are loaded and amended correctly.

Latest calendar would seem a good idea next.  I need to download it afresh from calendar.abingdon.org.uk.  I have thought about automating this, but haven't implemented any code yet.  I need a csv file from the school's calendar.  Go for 1st September 2014 to 31st December 2015.  Or perhaps just 1st January 2015 on?  Try the longer one first and see what happens.  There are some gash entries from last term, but all goes well.

Just found an interesting issue.  If you change the dates which the importing dialogue offers you, then your new dates are used for the purging process, but not for the import process.  Thus because I changed the date from 4/9/14 to 1/1/15, events between those two dates didn't get purged, but did get reloaded.  They thus ended up being there twice.  I should fix the code so it doesn't do this.  Done that.  Seems to work.  Promote to live system and then import the calendar there.  Done.

Now, suspended lessons.  ICF was quite keen that these should be reflected in my code, so let's take a look.  I believe I am already fetching the relevant file from SB, and it's quite short.  I am, and it is.

Easy to load it into my loader code.  Then just need to process it appropriately.
