Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2016-07-22T06:14:11+01:00

====== Friday 22 Jul 2016 ======

Just noticed that there are meetings in the iSAMS timetable which I'm not currently importing.  They show up as separate records in the data feed.  I should add those to my events - they can come in as part of the timetable.

Pete reports two missing members of staff in his load - 779 and 825.  Who are they?

779 is just JOW.  Jo Watt.
825 is Elizabeth Jewitt

OK - my target for today is to incorporate meetings in my Scheduler feed.  They seem to be there in the file which I get from iSAMS.  Onward an upward.  Also need to investigate why third year lessons are no longer being suspended after break on the first day back.  Perhaps do that first as it's there.

Firstly, what years does the system think the hiatus applies to?  Re-instate some logging code to find out.

Ah - it thinks it applies to years 0,1,2.  Clearly something in my offsets is wrong.  I thought boys had been moved up by a year, which is why I took the "--ahead 1" bit out of my command invocation.

The last pupil in the Lower School group is Cameron Yu.  His NC year in the feed from iSAMS is given as 10!  Eek.  Why is he in the lower school group?  10 seems to be correct - he was in 3OCP last year, so now he should be in the 4th year, or year 10.

Scheduler thinks he is in the 3rd year, but that's right because we haven't yet changed the current era in Scheduler.  Still doesn't explain why he is listed as being in the lower school though.

The group "Lower school" has only two direct members - 1st year and 2nd year.  It also has no apparent members after the end of August.  Ah - looking at the wrong Lower school group - there are several belonging to different eras.  I want the perpetual one I think.

1st year currently has 59 members.  On the 1st of September it will have 66 members.  The last one is Robin Hambidge.  He certainly seems to be a 1st year.

Found the group I want - it's called "Lower School Pupils".  128 members today.  198 members on the 1st of September (seems a lot).

Interesting.  On the first of September, 1st year has 66 members and 2nd year has 62 members, but "Lower School pupils" has 198 members.  Odd?

A lot of them seem to have no tutor group.  E.g.

Benedict Schilizzi
Shreyanshu Mohanty
Rory Kind

Let's look at them.

Benedict Schilizzi is in 1C, but has no tutor.  The ones who do have a tutor are in as 1CALM.  Have I got duplicate records or something?  Odd that the 1st and 2nd year have come out right.

Interesting that I categorize pupils by the house that they're in.  Perhaps some of the third years haven't had their house updated yet?

Ah yes - if I do a search by house, I get 186 pupils in Lower School.  Clearly things are not quite up to date in iSAMS.  I have 198, but perhaps someone is working on fixing them.  OK. - Don't use Lower School for the suspension - use 1st and 2nd years, and try again.  Hmm. The Hiatus still applies to years 0,1,2.  Interesting.

With the hiatuses, I'm wondering whether it's just that I'm evaluating the groups in the context of the wrong year.  Perhaps they have exactly the right pupils in them, but I'm calculating what year they'd be in if they were in the current (just ending) academic year.  That would explain it, and perhaps I've never done it out-of-year before?  Take a look.

Calling event.pupil_year_groups - not passing any context.  Ah - it seems to be trying to evaluate things on its scheduled date, which arguably makes a lot of sense.  Ah, but it might be getting the right pupils, but then evaluating them on the wrong date.  It needs to check what year they are in //on its own date//.  Currently it's being driven by the setting of the current era.

The simple fix is just to edit the current era, but is it the right fix?  Needs thinking about.  I can't just use the date of the event, because then half way through the year, pupils will seem to move up by a year.  The year_group is calculated from the pupil's notional start year, and the start year of the era.  I really need to do a bit of clever fiddling for events which don't fall in the current era.  Perhaps an "as at" date which is passed in to year_group.  Or indeed, pass in an era.

Done that, and it seems to work.  I now correctly identify the years as 1,2,3 and the 3rd year lessons seem to get suspended.  Oddly though, the lesson for 1S Hi now gets re-instated.  What pupils are in that set?  None at all.  There is no set with that name.  Could be the problem.  It was suspended because it had no pupils.  Who teaches 1S Hi?

Richard Jackson is teaching that lesson in G6, but there is as yet no group attached.  We thus don't know that it's a 1st year lesson, and so it isn't suspended.  All explained.

Let's get rid of the spurious prefects in the extra groups files.  Done that.

OK - stage the next is to get my meetings loaded.  They exist within a timetable, at the same level as schedules.

Ah - interesting problem.  The timetable entries and the meeting entries have a separate set of IDs, and so there could be collisions between them.  I can't therefore use the unadorned ID as the source ID.

And another new thing from iSAMS - Year Schedules.  These are in parallel to lessons and meetings.  I can add those in too.

Those seem OK, except that James Mage seems to be a 4th year in 3DB.  Check that out.  No - he should be in 4/DJTF/AJPE.  Check his current memberships - it may just be a naming issue.  Yes, he's definitely a member of his new tutor group, but he doesn't seem to have lost the old one yet.  He's still a member of 3DB too.  When should the old ones be corrected?

Yes, he's currently a member of 3DB, and he will be a member of 4/DJTF/AJPE from 1/9/16.  That's all correct, but it means his name hasn't changed yet.

When do old tutorgroups get terminated?  Something which I need to think about.  Ah - his old tutor group already has an end date - 2016-08-31.  However his membership of it doesn't have an end date yet.  Surely that should have happened when the group was marked for termination.  Or was its end date set when it was first created?

Let's reload the database as it was before I started running scripts and take a look.  Yes, the group already had an end date before we started our processing.  Arguably, when we add a member to a group we should check whether the group already has an end date, and if it does then set the membership as having that end date too.  A membership cannot outlast a group.

One to think about the best way to fix it.  I arguably can't get the pupils correctly named until after 31st August.

Just hit another problem when I tried to load everything again from scratch.  Suddenly it couldn't cope with one of my tutor groups.  Presumably this is because I'm trying to find the staff ID as I set up the in-memory records, and this relates to a new member of staff who isn't in the d/b yet.  Defer finding the staff id.
