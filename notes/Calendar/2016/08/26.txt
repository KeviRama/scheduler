Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2016-08-26T08:01:42+01:00

====== Friday 26 Aug 2016 ======

Interesting problem this morning which overrides the things which I was planning to do.  There were a number of new teaching groups created yesterday (2nd year) and whilst most things seem to have happened in an orderly fashion, one pupil has thrown up warning messages.

'''
Field email differs for Sharon Spooner
d/b: "hr.assistant@abingdon.org.uk" IS: "sharon.spooner@abingdon.org.uk"
1 staff record(s) amended.
4 staff record(s) created.
Failed to add Taylor Willis to group 2R Ar2
Failed to add Taylor Willis to group 2R Ar2
Failed to add Taylor Willis to group 2R Dr2
Failed to add Taylor Willis to group 2R Dr2
Failed to add Taylor Willis to group 2R DT2
Failed to add Taylor Willis to group 2R DT2
Failed to add Taylor Willis to group 2R Co2
Failed to add Taylor Willis to group 2R Co2
Failed to add Taylor Willis to group 2R Mu2
Failed to add Taylor Willis to group 2R Mu2
14 teaching group records created.
Removed 42 pupils from teaching groups.
Added 1042 pupils to teaching groups.
Started with 598 teaching groups and finished with 612.
561 timetable events added.
1411 resources added to timetable events.
1 added to "All staff" group.
2 removed from "2nd year Mathematics teachers" group.
2 added to "2nd year Mathematics teachers" group.
3 added to "Mathematics pupils" group.
3 removed from "2nd year Mathematics pupils" group.
3 added to "2nd year Mathematics pupils" group.
1 added to "Physical Education pupils" group.
1 added to "4th year Physical Education pupils" group.
14 added to "Private Study pupils" group.
14 added to "6th year Private Study pupils" group.
3 added to "2nd year teachers" group.
Field name differs for Event - Taster Morning 05/11/16 WL (Admissions)
d/b: "Event - 1YTM 5/11/16 WL (Admissions)" IS: "Event - Taster Morning 05/11/16 WL (Admissions)"
1 tag group records amended.
1 tag group records created.
Added 8 pupils to tag groups.
'''


Note that, the failure messages for Taylor Willis occur more than once per group.  The list of groups that the system has struggled with are 2R Ar2, 2R Dr2, 2R DT2, 2R Co2 and 2R Mu2.  5 groups.  Two error messages per group.

I can reproduce the problem on my development system, which is good.  Now, did those groups exist yesterday?  Happily the live system is so far untouched.  2R Ar2 existed and was created on 15/8/16, so it's not a hangover or anything like that.  How many members did it have?  16.  Taylor Willis was not one of them.  He did however exist and seems to have been in some art group.  Which one?  He was in 2R Ar4.

What is the situation after last night's update?  2R Ar2 still has 16 members.  Taylor Willis is now a member, so presumably we've had some re-setting.  His membership was created this morning.  What about his old membership?  Indeed, he has been removed from 2R Ar4, but is still recorded as having been a member until yesterday.  Why then the failure messages?  What can cause an addition to fail?  Group.add_member has returned false.  Why?  The most likely reason is that he is already a member.  Why might I try to add him more than once?

His pupil ID is 13018.  SchoolId is 752385358435

Ah - I think I may have the cause of the problem.  Here is an extract from data.xml

'''
<SetList Id="26888" SetId="4059" PupilId="13018" AuthorId="426">
  <SetId Legacy="True">4059</SetId>
  <SchoolId Legacy="True">752385358435</SchoolId>
  <Author Legacy="True">OliverLomax19240997956608</Author>
  <LastUpdated>2016-08-25T09:25:46.357</LastUpdated>
</SetList>
<SetList Id="27017" SetId="4059" PupilId="13018" AuthorId="426">
  <SetId Legacy="True">4059</SetId>
  <SchoolId Legacy="True">752385358435</SchoolId>
  <Author Legacy="True">OliverLomax19240997956608</Author>
  <LastUpdated>2016-08-25T09:25:50.723</LastUpdated>
</SetList>
<SetList Id="27150" SetId="4059" PupilId="13018" AuthorId="426">
  <SetId Legacy="True">4059</SetId>
  <SchoolId Legacy="True">752385358435</SchoolId>
  <Author Legacy="True">OliverLomax19240997956608</Author>
  <LastUpdated>2016-08-25T09:25:55.120</LastUpdated>
</SetList>
'''

And set 4059 is 2R Ar2.  This fully explains the problem.  I just need to add some code to cope with what is presumably a bug in iSAMS.

Added some code.  Now re-load with the database as it was before I started this morning and try again.

Right - now starting to look seriously at this problem of iSAMS having duplicate membership records.  I wonder whether perhaps I should whinge about them by default, and add a "--quiet" option in order to shut the utility up.

OK - fixed and deployed.  Now how about sorting some of those missing gaps.  Added in the two missing gaps, which seem fine as far as getting rid of lessons is concerned.  Now I need to upgrade the importer so that OH events take account of gaps too - iSAMS doesn't seem to manage that, and we have OH activities running right through half term.

My current code (in misimport/mistimetable.rb) merely notes hiatuses against the events stored in @entries.  The iSAMS code has OH events on top of that.  Perhaps the correct thing to do is to override the note_hiatuses() instance method in MIS_Schedule.  Let's try that.  Done it, but it didn't have the desired effect.  Where do the hiatuses get evaluated?
