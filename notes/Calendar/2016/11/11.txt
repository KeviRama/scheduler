Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2016-11-11T10:30:55+00:00

====== Friday 11 Nov 2016 ======

A couple of little wrinkles (or possibly just one) in the data import this morning.  The loader whinged about some of the cover.  Take a manual look to see whether it is actually whinge-worthy.  Text is:

'''
Commitment seems to be covered already.
Failed to save cover.
Element has already been taken
staff_ab_line_ident =
staff_covering:
  name Sophie Payne
dblesson:
  body: 2 Gn2
  eventcategory: Lesson
  starts_at: 2016-11-11 11:10:00 +0000
  ends_at: 2016-11-11 12:05:00 +0000
original_commitment:
  element.name: ACW - Alexandra Cardinal von Widdern
'''


So, what's going on?  Sophie Payne does indeed seem to be down to cover Alex, and it shows up in Scheduler.  It seems almost as if there are two entries for Sophie to cover the same lesson.  Check the source file.

'''
TblCoverManagerCoverID,intCycle,TblTimetableManagerScheduleID,blnRecurring,dteDate,txtCoverTeacher,intCoverType,intCoverRoom,blnVisible,txtNotes,blnEnabled,blnPublished,intMinutes,txtCreatedBy,dteCreatedDateTime,txtSubmitBy,dteSubmitDateTime
620,3,18581,false,2016-11-11 00:00:00 +0000,SophiePayne44817446459904,1,-1,true,"",true,false,0,IanFishpool131968999196288,2016-11-10 08:22:11 +0000,IanFishpool131968999196288,2016-11-10 08:22:11 +0000
621,3,18581,false,2016-11-11 00:00:00 +0000,SophiePayne44817446459904,1,-1,true,"",true,false,0,IanFishpool131968999196288,2016-11-10 08:22:23 +0000,IanFishpool131968999196288,2016-11-10 08:22:23 +0000
'''


Indeed - the same entry is there twice.  An SEP - move on.

Let's finish off the packaging of the release by preparing a sample crontab to put in the distribution.  I thought I had done something like this before, but can't now find it.  Done.

Steps need to install release on live system.

[ ] Back up database.
[ ] export RAILS_ENV=production
[ ] Remove apple image files in public dir and revert favicon.ico to default
[ ] Fetch new source code (git pull)
[ ] rake db:migrate
[ ] rake assets:precompile
[ ] touch tmp/restart.txt
[ ] Test run for current week
[ ] Test run for next week
[ ] Edit crontab to put in new timings of stuff


Right - that's prepared.  Next job for today is to attempt a blank install on a new PC.  I'll use monk for that purpose as it has none of Scheduler on it now.  I want to see what I could do for ASH.  It might be necessary to start on my automatic school generator and a corresponding new import method.  Document what I'm doing here, but actually do it on Monk.  I have some instructions already so I will work on polishing them.

I don't need to worry about getting from Development to Production since that's already well-documented.  What I'm interested in is setting up a blank d/b.

Followed the existing instructions as far as doing "bundle install".  The next step is to get a copy of an existing Scheduler database, so this is where our paths diverge.  What happens if I simply boot up scheduler with nothing in the database?  ISTR there is a Rails way to do initial population of a database.  I should use that here.  db/seeds.rb seems to be the right thing to use.  What does it contain?  Just comments, but seems straightforward enough.

Interesting, if I run up the app as it stands it fails with an error in the tzinfo stuff -

''/home/john/.rvm/gems/ruby-2.1.10@scheduler/gems/tzinfo-1.1.0/lib/tzinfo/transition_data_timezone_info.rb:79:in `transition': failed to allocate memory (NoMemoryError)''

Seems a little odd.  Is this because of my blank database?  Ah, hang on - I haven't even created the database tables yet.  How does one do that?  rake db:schema:load.  Exactly the same error.  Must be something wrong with my setup.  My computer has 8G of RAM and half of it is unused, so it's not the real problem.

A bit of reading.  I am using tzinfo version 1.1.0 which apparently has difficulty with timezone files generated by zic version 2014c and later.  Jessie has 2.19.  Stretch has 2.24.  That presumably is the problem.  Can I upgrade to a later version of tzinfo?

I've tried requesting tzinfo 1.2.2 or above, as specified in the page https://github.com/tzinfo/tzinfo/issues/30 and then did bundle update tzinfo.  I don't think that's changed too much else - just thread_safe.

Try again to load the schema.  Golly - it seems to be working.  Now what happens if I run up the application?  Well, it starts.

I'm boggled - quite a few complaints, but it does actually display a blank calendar.  Look at the log file to see what the complaints were.  Actually, all the complaints were about potential future incompatibilities between Foundation and Sass.

The database is going to need at the very least a user (admin) and some settings.  Can I get away with just a user?  Can he then create the system settings?  Or should I create a member of staff, and have the user record be created automatically when the corresponding user logs in?)

