Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2016-11-18T09:39:07+00:00

====== Friday 18 Nov 2016 ======

Interesting problem arose over night.  The import process gave the following output.

'''
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Dropped 2 covers.
'''


before going on to rename a student, etc.  The above messages came at the beginning.  Running it again with verbose on, they appeared between messages as follows:

'''
Got 239 other half groups.
Couldn't find pupil with id 679166673961.
Couldn't find pupil with id 679166673961.
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Unable to find entries using selector "Periods Period".
Got 5057 timetable entries.
'''


which appears to suggest they are timetable entries.  Check in more detail.

So - either in mis_specific_preparation or in build_scheduler in the timetable bit.  The latter seems much more likely.  That's defined in isams/mistimetable.rb.  It in turn calls MIS_Scheduler.new passing it the timetable data.

Let's add some more debug lines in there so I can see which bit of the timetable it was constructing at the time.

I wonder whether my code should be a little more defensive?  I don't want to go deleting the whole future timetable because the iSAMS file misses out some data.  Do I ever abort the process for lack of data?

Interesting - those messages come out before we get to processing specific lesson entries.  Perhaps my guess was wrong?  Could it be in week construction?  Yes, indeed it is.  Onwards and inwards.

There are still just the three weeks which there always were.

Very odd - my code seems to think there's an unnamed period at the end of each day, and yet I can't see it when I look at the data file.

Take the structure section from today's file, and the one from yesterday's and diff them.

Interesting.  They seem to have added an extra field within the entry for each day - also called "Day" stupidly enough = which as far as I can see gives the number of the day within the week, with Sunday being 1, Monday 2, etc.

	''<Structure>''
''      <Week Id="1">''
''        <Name>Senior Week A</Name>''
''        <ShortName>SWA</ShortName>''
''        <Ordinal>1</Ordinal>''
''        <Active>1</Active>''
''        <ShowTimetableWeek>0</ShowTimetableWeek>''
''        <Author>adminjka126699234003904</Author>''
''        <LastUpdated>2016-05-20T14:23:17</LastUpdated>''
''        <Days>''
''          <Day Id="1">''
''            <Name>Monday</Name>''
''            <ShortName>Mon</ShortName>''
''            <Day>2</Day>				<<<< This line is new''
''            <Ordinal>1</Ordinal>''
''            <Active>1</Active>''
''            <Author>ADMIN379195924992lh</Author>''
''            <LastUpdated>2016-05-20T13:35:59.133</LastUpdated>''
''            <Periods>''
''              <Period Id="1">''
''                <Ordinal>1</Ordinal>''
''                <Name>Registration</Name>''
''                <ShortName>Reg</ShortName>''
''                <StartTime>08:35</StartTime>''
''                <EndTime>08:55</EndTime>''
''                <Author>ADMIN379195924992lh</Author>''
''                <LastUpdated>2016-05-20T13:35:59.210</LastUpdated>''
''              </Period>''

Not sure why it has the effect which it has on my code though.  It shouldn't get picked up at all because I'm not looking for it.  It would have been much more sensible to call it DayNo, and index from 1, but iSAMS don't do sensible.

Why then does it have the effect which it has?  Why does it produce only one extra phantom period per day?  Ah, perhaps the way the selector works, it will go deeper?  Need to look at the Nokogiri documentation.

I should perhaps be using xpath() instead of css() to do my selection.  It appears that the former will let me be more specific about how nested something can be - I can specify that it needs to be an immediate child, and not just a descendant.  Not for today though.
